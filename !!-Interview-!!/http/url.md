# 输入 url 到页面渲染经历什么
看了很多篇文章，发现大佬们开头总结的过程总是有个 1，2，3，4..7 8步，文章写得真好，但是开头总有种劝退我的感觉，看着害怕犯困。
所以我觉得这个问题大致上就和 `“把大象塞进冰箱”` 一样，也是三大步。
一是 处理 url，二 获取数据，三 浏览器渲染

哈哈哈是不是太简单了，下面我们仔细看看每一步都在搞些什么？

## 1.处理 url
### 1.1 输入 url，请求之前
暂时先不说`从输入 url 到被浏览器接收`这部分的内容，这部分主要跟 输入输入硬件设备，CPU处理和操作系统内核有关。先说说跟浏览器，网络有关的部分

当用户输入关键字点击搜索之后，当前页面就将要被替换成新的页面，在替换新页面之前（拿到新页面数据，更换页面），浏览器还给了当前页面一次执行 `beforeunload` 事件的机会。`beforeunload` 事件允许当前页面不直接关闭，在这里可以触发提醒页面关闭的对话框和执行一些数据清理操作，也可以取消关闭或刷新。

### 1.2 浏览器接收 url 到 开启网络请求进程
这部分的主要内容有关：浏览器进程/线程模型，JS的运行机制
> **进程是资源分配的最小单位，线程是 CPU 调度的最小单位**
简单的说，进程就像列火车，而线程就是车厢
线程必须依附于进程存在，一个进程可以有多个线程
<br>

##### 多进程的浏览器
浏览器是多进程的，有一个主控进程，然后每打开的 tab 页都会新开一个进程（有时会合并）
*谷歌浏览器设置里打开任务管理器，每个任务就是一个进程*

进程包括：
- 主控进程：浏览器的主进程（负责协调，主控），唯一的
- 插件进程：每种类型的插件对应一个进程，当使用该插件时才创建进程
- GPU 进程：最多一个，用于 3D 绘制
- 浏览器渲染进程：默认每个 Tab 页一个进程，互不影响。控制页面渲染，脚本执行，事件处理等（有时候会优化，如多个空白 tab 会合并成一个进程）
<br>

##### 多线程的浏览器内核
每个 tab 页都可看作一个浏览器内核进程，这个进程是 *多线程* 的。它有几大类子线程：
- GUI 线程
- JS 引擎线程 
- 事件触发线程
- 定时器线程
- 网络请求线程

JS 引擎是内核进程中的一个线程，这也是为什么常说 **JS 引擎是单线程的**
为什么是单线程可以点击看这里 [Click Here!!](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)

##### 网络请求都是单独的线程
浏览器会根据解析得到的协议，开辟一个网络线程，前往请求资源。每次网络请求时都需要开辟单独的线程进行。

##### 更多
关于浏览器的进程机制,包括JS运行机制，进程线程的详解可以看这里
[从浏览器多进程到JS单线程，JS运行机制最全面的一次梳理](https://segmentfault.com/a/1190000012925872)

### 1.3 开启网络请求进程 到 发出完整http请求
##### url 是什么
URL (Uniform Resource Locator) 统一资源定位符，俗称网址。遵守以下语法规则
```
scheme://host.domain:port/path/filename
```
- scheme : 因特网服务类型。常间的协议有 http,https,ftp,file,其中最常见的类型是 http，而 https 则是进行加密的网络传输

- host : 域主机（http 的默认主机是 www）

- domain : 因特网域名，例如 `xxx.com.cn`

- port : 主机上的端口号（http 默认端口号是 80）

- path : 服务器上的路径（如果省略，则文档必须位于网站的根目录中）

- filename : 文档/资源的名称

##### 域名解析
输入网址后，浏览器并不能直接通过网址找到对应的服务器进行通信，而是需要 `IP 地址` 

> *为什么有了网址又需要 IP 地址呢？*
因为 IP 地址是形如 `192.168.1.1` 这种的，方便计算机识别，但是对于人来说很难记。
为了方便人使用，就创造了网址


- 本地缓存查找
首先，浏览器会先查找本地缓存是否缓存了目标资源。如果有该资源，那就直接把该资源拿给浏览器进程；如果没有查找到该资源，那就进入网络请求进程。

**在浏览器内核中查看缓存**
  > 浏览器和浏览器内核是不同的概念，浏览器指的是 Chrome, Firefox，而浏览器内核则是Blink,Genko
  > 浏览器内核只负责渲染，GUI和网络连接等跨平台工作则是由浏览器实现的

如果本地缓存没找到资源，那就要从网络服务器请求资源。那就需要用 IP 地址跟服务器建立连接。我们输入的 url 需要通过 DNS 解析才能得到 IP 地址。

- DNS 解析
DNS(domain name system) 是一个域名服务器，DNS 上记录了一张域名与之对应的 IP 地址的表。
浏览器通过向 DNS 服务器发送域名，查询到与域名相对应的 IP 地址，然后返回给浏览器。
<br>
- 建立连接
获取请求域名的服务器 IP 地址。如果请求的协议是 HTTPS，那还需要建立 TLS 连接。接下来就是用 IP 地址和服务器建立 TCP 连接。

> 参考文章
[1](https://zhuanlan.zhihu.com/p/57895541)
[2](https://zhuanlan.zhihu.com/p/34453198)